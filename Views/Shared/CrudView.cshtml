@{
    ViewData["Title"] = ViewBag.Title ?? "CRUD ƒ∞≈ülemleri";
    var entityName = ViewBag.EntityName ?? "Kayƒ±t";
    var endpoint = ViewBag.Endpoint ?? "";
}

<div class="container-fluid px-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="mb-0">üìã @ViewData["Title"]</h3>
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createModal">
                    ‚ûï Yeni @entityName
                </button>
            </div>
        </div>
    </div>

    <!-- Tablo -->
    <div class="card shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="dataTable">
                    <thead class="table-light">
                        <tr id="tableHeaders"></tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr><td class="text-center py-4">Y√ºkleniyor...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Durum Mesajlarƒ± -->
    <div id="alertContainer" class="mt-3"></div>
</div>

<!-- Create/Edit Modal -->
<div class="modal fade" id="createModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Yeni @entityName</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="crudForm"></form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒ∞ptal</button>
                <button type="button" class="btn btn-primary" onclick="saveData()">Kaydet</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    const config = {
        endpoint: '@endpoint',
        entityName: '@entityName',
        fields: @Html.Raw(Json.Serialize(ViewBag.Fields ?? new[]
        {
            new { name = "kod", label = "Kod", type = "text", required = true },
            new { name = "isim", label = "ƒ∞sim", type = "text", required = true }
        }))
    };

    let editingId = null;

    // Sayfa y√ºklendiƒüinde
    document.addEventListener("DOMContentLoaded", () => {
        loadData();
        generateForm();
    });

    // Form olu≈ütur
    function generateForm() {
        const form = document.getElementById('crudForm');
        form.innerHTML = config.fields.map(field => `
            <div class="mb-3">
                <label class="form-label">${field.label}</label>
                <input type="${field.type}" 
                       class="form-control" 
                       name="${field.name}" 
                       ${field.required ? 'required' : ''}>
            </div>
        `).join('');
    }

    // Verileri y√ºkle
    async function loadData() {
        try {
            const response = await fetch(`/${config.endpoint}/List`);
            const data = await response.json();
            renderTable(data);
        } catch (error) {
            showAlert('Veriler y√ºklenirken hata olu≈ütu', 'danger');
        }
    }

    // Tabloyu render et
    function renderTable(data) {
        const headers = document.getElementById('tableHeaders');
        const body = document.getElementById('tableBody');
        
        if (!data || data.length === 0) {
            body.innerHTML = '<tr><td class="text-center py-4">Kayƒ±t bulunamadƒ±</td></tr>';
            return;
        }

        // Headers
        const keys = Object.keys(data[0]);
        headers.innerHTML = keys.map(k => `<th>${k}</th>`).join('') + '<th width="150">ƒ∞≈ülemler</th>';

        // Body
        body.innerHTML = data.map(item => `
            <tr>
                ${keys.map(k => `<td>${item[k] || '-'}</td>`).join('')}
                <td>
                    <button class="btn btn-sm btn-warning" onclick='editData(${JSON.stringify(item)})'>‚úèÔ∏è</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteData('${item[keys[0]]}')">üóëÔ∏è</button>
                </td>
            </tr>
        `).join('');
    }

    // Kaydet
    async function saveData() {
        const form = document.getElementById('crudForm');
        const formData = new FormData(form);
        const data = Object.fromEntries(formData);

        try {
            const url = editingId 
                ? `/${config.endpoint}/Update/${editingId}`
                : `/${config.endpoint}/Create`;
            
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                showAlert(`${config.entityName} ba≈üarƒ±yla ${editingId ? 'g√ºncellendi' : 'eklendi'}`, 'success');
                bootstrap.Modal.getInstance(document.getElementById('createModal')).hide();
                loadData();
                form.reset();
                editingId = null;
            }
        } catch (error) {
            showAlert('ƒ∞≈ülem sƒ±rasƒ±nda hata olu≈ütu', 'danger');
        }
    }

    // D√ºzenle
    function editData(item) {
        editingId = item[Object.keys(item)[0]];
        document.getElementById('modalTitle').textContent = `${config.entityName} D√ºzenle`;
        
        const form = document.getElementById('crudForm');
        Object.keys(item).forEach(key => {
            const input = form.querySelector(`[name="${key}"]`);
            if (input) input.value = item[key];
        });
        
        new bootstrap.Modal(document.getElementById('createModal')).show();
    }

    // Sil
    async function deleteData(id) {
        if (!confirm('Silmek istediƒüinizden emin misiniz?')) return;

        try {
            const response = await fetch(`/${config.endpoint}/Delete/${id}`, { method: 'POST' });
            if (response.ok) {
                showAlert(`${config.entityName} silindi`, 'success');
                loadData();
            }
        } catch (error) {
            showAlert('Silme i≈ülemi ba≈üarƒ±sƒ±z', 'danger');
        }
    }

    // Alert g√∂ster
    function showAlert(message, type) {
        const container = document.getElementById('alertContainer');
        container.innerHTML = `
            <div class="alert alert-${type} alert-dismissible fade show">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        setTimeout(() => container.innerHTML = '', 5000);
    }
</script>
}
